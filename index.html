<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è‰¯ã„ã“ã¨æ‚ªã„ã“ã¨è€ƒå¯Ÿç”¨</title>

<style>
  body { 
    font-family: sans-serif; 
    background: #ffffcc; 
    padding: 20px; 
  }

  .voteResult {
    font-weight: bold; 
    margin-left: 10px; 
    color: #cc9900;
  }

  #chatBox { 
    border: 1px solid #cc9900; 
    background: #fff8b3; 
    padding: 10px; 
    height: 300px; 
    overflow-y: auto; 
  }

  input, textarea { 
    width: 100%; 
    margin-bottom: 10px; 
    padding: 8px; 
    font-size: 1em; 
  }

  button { 
    background-color: #cc9900; 
    color: white; 
    padding: 10px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    margin-bottom: 10px;
  }

  .row {
    display: flex;
    gap: 10px;
  }

  .row button {
    flex: 1;
  }

  p.message {
    border-bottom: 1px solid #cc9900;
    padding-bottom: 5px;
    margin-bottom: 5px;
  }

  #adminBox {
    margin-top: 40px;
    padding: 15px;
    border: 2px dashed #aa7700;
    background: #fff3a0;
  }

  /* ç›®æ¬¡ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  #toc {
    margin: 10px 0 30px 0;
  }

  #toc a {
    color: #cc9900;
    color: #0066ff;
    text-decoration: none;
    font-weight: bold;
    margin-right: 15px;
  }

  #toc a:hover {
    text-decoration: underline;
  }

  /* ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«é¢¨ */
  #stampSelector {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #fff8b3;
    border: 2px solid #cc9900;
    border-radius: 8px;
    padding: 15px;
    z-index: 1000;
    box-shadow: 0 0 10px #cc9900;
  }
  #stampSelector h3 {
    margin-top: 0;
    color: #cc9900;
  }
  #stampSelector .stampList {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    max-width: 300px;
  }

  #stampSelector .stampList img {
    width: 60px;
    height: 60px;
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 6px;
    transition: border-color 0.2s;
  }
  #stampSelector .stampList img:hover {
    border-color: #cc9900;
  }
  #stampSelector button.closeBtn {
    background: #cc9900;
    margin-top: 10px;
    margin: 5px;
  }

</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>

<body>

<h1>è‰¯ã„ã“ã¨æ‚ªã„ã“ã¨è€ƒå¯Ÿç”¨</h1>
<p>ä½œ: ã‚‰ã‚‚</p>

<!-- ã“ã“ã‹ã‚‰ç›®æ¬¡ -->
<div id="toc">
  <a href="#voteSection">æŠ•ç¥¨</a>
  <a href="#messageSection">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</a>
  <a href="#adminSection">ç®¡ç†è€…æ¨©é™</a>
</div>
<!-- ç›®æ¬¡ã“ã“ã¾ã§ -->

<h2 id="voteSection">æŠ•ç¥¨ãŠé¡˜ã„ã—ã¾ã™</h2>
<p>çŠ¯äººã¯èª°ã ã¨æ€ã†ï¼Ÿ</p>

<div>
  <label><input type="radio" name="vote" value="ã‚¿ã‚«ã‚­ãƒ³ã‚°"> ã‚¿ã‚«ã‚­ãƒ³ã‚°</label>
  <span class="voteResult" id="takakingCount">0 ç¥¨</span>
</div>

<div>
  <label><input type="radio" name="vote" value="ã‚¿ãƒ¼ãƒœãƒ¼"> ã‚¿ãƒ¼ãƒœãƒ¼</label>
  <span class="voteResult" id="taboCount">0 ç¥¨</span>
</div>

<div>
  <label><input type="radio" name="vote" value="ã‚¿ãƒ¼ãƒœãƒ¼ã®å¦»"> ã‚¿ãƒ¼ãƒœãƒ¼ã®å¦»</label>
  <span class="voteResult" id="taboWifeCount">0 ç¥¨</span>
</div>

<div>
  <label><input type="radio" name="vote" value="ã‚¤ãƒã‚¯ãƒ‹"> ã‚¤ãƒã‚¯ãƒ‹</label>
  <span class="voteResult" id="imakuniCount">0 ç¥¨</span>
</div>

<div>
  <label><input type="radio" name="vote" value="åˆ‘äº‹"> åˆ‘äº‹</label>
  <span class="voteResult" id="keijiCount">0 ç¥¨</span>
</div>

<div>
  <label><input type="radio" name="vote" value="ã‚¢ãƒãƒ­"> ã‚¢ãƒãƒ­</label>
  <span class="voteResult" id="apolloCount">0 ç¥¨</span>
</div>

<button onclick="vote()">æŠ•ç¥¨ã™ã‚‹</button>

<hr>

<h2 id="messageSection">ãŠè©±ã—ã‚¾ãƒ¼ãƒ³</h2>

<p>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </p>
<input type="text" id="nameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">

<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
<input id="nameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
<textarea id="messageInput" rows="4"></textarea>

<div class="row">
  <button onclick="sendMessage()">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹</button>
  <button onclick="sendMessage()">é€ä¿¡</button>
  <button onclick="toggleUnknownTime()" id="timeBtn">æ™‚é–“ï¼šé€šå¸¸</button>
</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒœã‚¿ãƒ³ -->
<button onclick="openStampSelector()">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸æŠ</button>
<div class="row">
  <button onclick="openStampSelector()">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸æŠ</button>
  <button onclick="shareBoard()">ã¿ã‚“ãªã‚’å‘¼ã¶ğŸ””</button>
</div>

<!-- ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="stampSelector">
  <h3>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã‚“ã§ã­ï¼</h3>
  <div class="stampList" id="stampList">
    <!-- ã‚¹ã‚¿ãƒ³ãƒ—ç”»åƒãŒã“ã“ã«å…¥ã‚‹ -->
  </div>
  <button class="closeBtn" onclick="closeStampSelector()">é–‰ã˜ã‚‹</button>
  <h3>ã‚¹ã‚¿ãƒ³ãƒ—</h3>
  <div class="stampList" id="stampList"></div>
  <button onclick="closeStampSelector()">é–‰ã˜ã‚‹</button>
</div>

<h3>ã¿ã‚“ãªã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
<div id="chatBox"></div>

<p id="onlineCount">è¦‹ã¦ã„ã‚‹äºº: 0äºº</p>
<p id="onlineIDs">è¦‹ã¦ã„ã‚‹äººã®ID: ãªã—</p>

<hr>

<div id="adminBox">
  <h2 id="adminSection">ç®¡ç†è€…æ¨©é™</h2>
  <input id="adminInput" placeholder="ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰">
  <button id="deleteAll">âš  å…¨å‰Šé™¤</button>

  <input type="text" id="adminInput" placeholder="ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰">

  <button id="deleteAll">âš  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€æ‹¬å‰Šé™¤</button>
  <h3>BAN</h3>
  <input id="banIDInput" placeholder="BAN ID">
  <button id="banBtn">BAN</button>
  <input id="unbanIDInput" placeholder="è§£é™¤ ID">
  <button id="unbanBtn">è§£é™¤</button>

  <h3>BANã‚·ã‚¹ãƒ†ãƒ </h3>

  <input type="text" id="banIDInput" placeholder="BANã™ã‚‹ID">
  <button id="banBtn">IDæŒ‡å®šã§BANã™ã‚‹</button>

  <input type="text" id="unbanIDInput" placeholder="è§£é™¤ã™ã‚‹ID">
  <button id="unbanBtn">IDæŒ‡å®šã§BANã‚’è§£é™¤ã™ã‚‹</button>

  <h4>ç¾åœ¨BANä¸­ã®IDä¸€è¦§</h4>
  <p id="banList">ãªã—</p>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDcds20u1-6-nk7710P4xddsa-m1wDL0TQ",
  authDomain: "iikotowaruikoto-d5aa7.firebaseapp.com",
  databaseURL: "https://iikotowaruikoto-d5aa7-default-rtdb.firebaseio.com",
  projectId: "iikotowaruikoto-d5aa7",
  storageBucket: "iikotowaruikoto-d5aa7.appspot.com",
  messagingSenderId: "455780219216",
  appId: "1:455780219216:web:225461fcf24c1a46f69455"
  databaseURL: "https://iikotowaruikoto-d5aa7-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function generateID() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let id = "";
  for (let i = 0; i < 8; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

let userID = localStorage.getItem("userID");
if (!userID) {
  userID = generateID();
  localStorage.setItem("userID", userID);
}

db.ref("bans/" + userID).on("value", s => {
  if (s.exists()) {
    document.body.innerHTML = "<h1>ã‚ãªãŸã¯BANã•ã‚Œã¦ã„ã¾ã™</h1>";
  }
});

// ===== æŠ•ç¥¨ =====
function updateVotesUI(votes) {
  takakingCount.innerText = (votes["ã‚¿ã‚«ã‚­ãƒ³ã‚°"] || 0) + " ç¥¨";
  taboCount.innerText = (votes["ã‚¿ãƒ¼ãƒœãƒ¼"] || 0) + " ç¥¨";
  taboWifeCount.innerText = (votes["ã‚¿ãƒ¼ãƒœãƒ¼ã®å¦»"] || 0) + " ç¥¨";
  imakuniCount.innerText = (votes["ã‚¤ãƒã‚¯ãƒ‹"] || 0) + " ç¥¨";
  keijiCount.innerText = (votes["åˆ‘äº‹"] || 0) + " ç¥¨";
  apolloCount.innerText = (votes["ã‚¢ãƒãƒ­"] || 0) + " ç¥¨";
}

db.ref("votes").on("value", s => updateVotesUI(s.val() || {}));

function vote() {
  const sel = document.querySelector('input[name="vote"]:checked');
  if (!sel) return alert("é¸ã‚“ã§ã­ï¼");
  db.ref("votes/" + sel.value).transaction(n => (n || 0) + 1);
}

// ===== ãƒãƒ£ãƒƒãƒˆ & æ™‚é–“ON/OFF =====
let userID = localStorage.getItem("userID") || Math.random().toString(36).slice(2,10);
localStorage.setItem("userID", userID);

let unknownTime = false;

function toggleUnknownTime() {
  unknownTime = !unknownTime;
  const btn = document.getElementById("timeBtn");
  btn.textContent = unknownTime ? "æ™‚é–“ï¼šä¸æ˜" : "æ™‚é–“ï¼šé€šå¸¸";
function toggleUnknownTime(){
  unknownTime=!unknownTime;
  timeBtn.textContent = unknownTime ? "æ™‚é–“ï¼šä¸æ˜" : "æ™‚é–“ï¼šé€šå¸¸";
}

const chatBox = document.getElementById("chatBox");

db.ref('messages').on('child_added', snap => {
  const msg = snap.val();
  const time = msg.timestamp === "unknown" ? "ä¸æ˜" : new Date(msg.timestamp).toLocaleString();
  const p = document.createElement("p");
  p.className = "message";

  if (msg.type === "stamp") {
    p.innerHTML = `<strong>${msg.name} [${msg.userID}]</strong><br><img src="${msg.stampUrl}" alt="ã‚¹ã‚¿ãƒ³ãƒ—" width="80" />` +
      `<br><small>${time}</small>`;
  } else {
    p.innerHTML = `<strong>${msg.name} [${msg.userID}]</strong><br>${msg.message}<br><small>${time}</small>`;
  }
function vote(){
  const v=document.querySelector('input[name="vote"]:checked');
  if(!v) return;
  db.ref("votes/"+v.value).transaction(n=>(n||0)+1);
}

  chatBox.prepend(p);
db.ref("votes").on("value",s=>{
  const v=s.val()||{};
  takakingCount.textContent=(v["ã‚¿ã‚«ã‚­ãƒ³ã‚°"]||0)+" ç¥¨";
  taboCount.textContent=(v["ã‚¿ãƒ¼ãƒœãƒ¼"]||0)+" ç¥¨";
  taboWifeCount.textContent=(v["ã‚¿ãƒ¼ãƒœãƒ¼ã®å¦»"]||0)+" ç¥¨";
  imakuniCount.textContent=(v["ã‚¤ãƒã‚¯ãƒ‹"]||0)+" ç¥¨";
  keijiCount.textContent=(v["åˆ‘äº‹"]||0)+" ç¥¨";
  apolloCount.textContent=(v["ã‚¢ãƒãƒ­"]||0)+" ç¥¨";
});

function sendMessage() {
  const name = document.getElementById("nameInput").value.trim();
  const message = document.getElementById("messageInput").value.trim();

  if (!name || !message) {
    alert("å…¥åŠ›ã—ã¦ã­ï¼");
    return;
  }

  const time = unknownTime ? "unknown" : Date.now();
db.ref("messages").on("child_added",s=>{
  const m=s.val();
  const t=m.timestamp==="unknown"?"ä¸æ˜":new Date(m.timestamp).toLocaleString();
  chatBox.innerHTML=`<p class="message"><b>${m.name}[${m.userID}]</b><br>`+
  (m.type==="stamp"?`<img src="${m.stampUrl}" width="80">`:m.message)+
  `<br><small>${t}</small></p>`+chatBox.innerHTML;
});

function sendMessage(){
  if(!nameInput.value||!messageInput.value) return;
  db.ref("messages").push({
    name,
    message,
    name:nameInput.value,
    message:messageInput.value,
    userID,
    timestamp: time,
    type: "text"
    timestamp: unknownTime?"unknown":Date.now(),
    type:"text"
  });

  document.getElementById("messageInput").value = "";
  messageInput.value="";
}

// ===== ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠæ©Ÿèƒ½ =====

const stamps = [
  "stamp1.png",
  "stamp2.png",
  "stamp3.png",
];

const stampSelector = document.getElementById("stampSelector");
const stampList = document.getElementById("stampList");

function openStampSelector() {
  stampList.innerHTML = ""; // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
  stamps.forEach(src => {
    const img = document.createElement("img");
    img.src = src;
    img.alt = "ã‚¹ã‚¿ãƒ³ãƒ—";
    img.onclick = () => {
      sendStamp(src);
      closeStampSelector();
    };
    stampList.appendChild(img);
const stamps=["stamp1.png","stamp2.png","stamp3.png"];
function openStampSelector(){
  stampList.innerHTML="";
  stamps.forEach(s=>{
    const i=document.createElement("img");
    i.src=s;
    i.onclick=()=>sendStamp(s);
    stampList.appendChild(i);
  });
  stampSelector.style.display = "block";
}

function closeStampSelector() {
  stampSelector.style.display = "none";
  stampSelector.style.display="block";
}

function sendStamp(stampUrl) {
  const name = document.getElementById("nameInput").value.trim();
  if (!name) {
    alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œã¦ã­ï¼");
    return;
  }
  const time = unknownTime ? "unknown" : Date.now();

function closeStampSelector(){stampSelector.style.display="none";}
function sendStamp(s){
  if(!nameInput.value) return;
  db.ref("messages").push({
    name: name,
    type: "stamp",
    stampUrl: stampUrl,
    userID: userID,
    timestamp: time
    name:nameInput.value,
    userID,
    stampUrl:s,
    timestamp: unknownTime?"unknown":Date.now(),
    type:"stamp"
  });
  closeStampSelector();
}

// ===== ç®¡ç†è€… =====

let isAdmin = false;

document.getElementById("adminInput").addEventListener("change", () => {
  isAdmin = document.getElementById("adminInput").value === "1x4s";
  alert(isAdmin ? "ç®¡ç†è€…OK" : "ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
});

document.getElementById("deleteAll").onclick = () => {
  if (!isAdmin) return alert("ç®¡ç†è€…ã®ã¿");
  if (confirm("å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) {
    db.ref("messages").remove();
    chatBox.innerHTML = "";
  }
};

document.getElementById("banBtn").onclick = () => {
  if (!isAdmin) return alert("ç®¡ç†è€…ã®ã¿");
  const id = document.getElementById("banIDInput").value.trim();
  if (!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (confirm(`IDã€Œ${id}ã€ã‚’BANã—ã¾ã™ã‹ï¼Ÿ`)) {
    db.ref("bans/" + id).set(true);
function shareBoard(){
  const text="æ²ç¤ºæ¿ã§å¾…ã£ã¦ã‚‹ã‚ˆï¼\nhttps://ikuradou745-oss.github.io/iikotowaruikoto/";
  if(navigator.share){
    navigator.share({text,url:"https://ikuradou745-oss.github.io/iikotowaruikoto/"});
  }else{
    navigator.clipboard.writeText(text);
    alert("æ–‡ç« ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
  }
};

document.getElementById("unbanBtn").onclick = () => {
  if (!isAdmin) return alert("ç®¡ç†è€…ã®ã¿");
  const id = document.getElementById("unbanIDInput").value.trim();
  if (!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (confirm(`IDã€Œ${id}ã€ã®BANã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
    db.ref("bans/" + id).remove();
  }
};

// ===== BANãƒªã‚¹ãƒˆã®è¡¨ç¤º =====
const banListP = document.getElementById("banList");
db.ref("bans").on("value", snapshot => {
  const bans = snapshot.val() || {};
  const ids = Object.keys(bans);
  banListP.textContent = ids.length === 0 ? "ãªã—" : ids.join(", ");
});

// ===== è¦‹ã¦ã„ã‚‹äººï¼ˆBANé™¤å¤–ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼‰ =====
const onlineCountP = document.getElementById("onlineCount");
const onlineIDsP = document.getElementById("onlineIDs");
const presenceRef = db.ref("presence/" + userID);
const presenceListRef = db.ref("presence");

// æ¥ç¶šçŠ¶æ…‹ã®ç®¡ç†
db.ref(".info/connected").on("value", snap => {
  if (snap.val() === true) {
    presenceRef.set(true);
    presenceRef.onDisconnect().remove();
  }
});

let currentBanIDs = [];
let currentPresenceIDs = [];

function updateOnlineDisplay() {
  // BANã•ã‚Œã¦ã„ã‚‹IDã‚’é™¤ã„ã¦è¡¨ç¤º
  const visibleIDs = currentPresenceIDs.filter(id => !currentBanIDs.includes(id));
  onlineCountP.textContent = `è¦‹ã¦ã„ã‚‹äºº: ${visibleIDs.length}äºº`;
  onlineIDsP.textContent = visibleIDs.length === 0 ? "è¦‹ã¦ã„ã‚‹äººã®ID: ãªã—" : `è¦‹ã¦ã„ã‚‹äººã®ID: ${visibleIDs.join(", ")}`;
}

db.ref("bans").on("value", snapshot => {
  const bans = snapshot.val() || {};
  currentBanIDs = Object.keys(bans);
  updateOnlineDisplay();
});

presenceListRef.on("value", snap => {
  const ids = [];
  snap.forEach(child => {
    ids.push(child.key);
  });
  currentPresenceIDs = ids;
  updateOnlineDisplay();
});
</script>

</body>
</html>
