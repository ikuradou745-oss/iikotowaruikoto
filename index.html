<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>良いこと悪いこと考察用</title>

<style>
  body { 
    font-family: sans-serif; 
    background: #ffffcc; 
    padding: 20px; 
  }

  .voteResult {
    font-weight: bold; 
    margin-left: 10px; 
    color: #cc9900;
  }

  #chatBox { 
    border: 1px solid #cc9900; 
    background: #fff8b3; 
    padding: 10px; 
    height: 300px; 
    overflow-y: auto; 
  }

  input, textarea { 
    width: 100%; 
    margin-bottom: 10px; 
    padding: 8px; 
    font-size: 1em; 
  }

  button { 
    background-color: #cc9900; 
    color: white; 
    padding: 10px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    margin-bottom: 10px;
  }

  .row {
    display: flex;
    gap: 10px;
  }

  .row button {
    flex: 1;
  }

  p.message {
    border-bottom: 1px solid #cc9900;
    padding-bottom: 5px;
    margin-bottom: 5px;
  }

  #adminBox {
    margin-top: 40px;
    padding: 15px;
    border: 2px dashed #aa7700;
    background: #fff3a0;
  }

  /* BANリストのスクロールと背景 */
  #banList {
    background: #fff8b3;
    padding: 10px;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #cc9900;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<h1>良いこと悪いこと考察用</h1>
<p>作: らも</p>

<h2>投票お願いします</h2>
<p>犯人は誰だと思う？</p>

<div>
  <label><input type="radio" name="vote" value="タカキング"> タカキング</label>
  <span class="voteResult" id="takakingCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="ターボー"> ターボー</label>
  <span class="voteResult" id="taboCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="イマクニ"> イマクニ</label>
  <span class="voteResult" id="imakuniCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="刑事"> 刑事</label>
  <span class="voteResult" id="keijiCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="アポロ"> アポロ</label>
  <span class="voteResult" id="apolloCount">0 票</span>
</div>

<button onclick="vote()">投票する</button>

<hr>

<h2>お話しゾーン</h2>

<p>ニックネーム</p>
<input type="text" id="nameInput" placeholder="ニックネーム">

<p>メッセージ</p>
<textarea id="messageInput" rows="4"></textarea>

<div class="row">
  <button onclick="sendMessage()">メッセージを送る</button>
  <button onclick="toggleUnknownTime()" id="timeBtn">時間：通常</button>
</div>

<h3>みんなのメッセージ</h3>
<div id="chatBox"></div>

<div id="adminBox">
  <h2>管理者権限</h2>

  <input type="text" id="adminInput" placeholder="管理者コード">

  <button id="deleteAll">⚠ メッセージ一括削除</button>

  <h3>BANシステム</h3>

  <input type="text" id="banIDInput" placeholder="BANするID">
  <button id="banBtn">ID指定でBANする</button>

  <input type="text" id="unbanIDInput" placeholder="解除するID">
  <button id="unbanBtn">ID指定でBANを解除する</button>

  <h4>BANされているIDリスト</h4>
  <ul id="banList"></ul>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDcds20u1-6-nk7710P4xddsa-m1wDL0TQ",
  authDomain: "iikotowaruikoto-d5aa7.firebaseapp.com",
  databaseURL: "https://iikotowaruikoto-d5aa7-default-rtdb.firebaseio.com",
  projectId: "iikotowaruikoto-d5aa7",
  storageBucket: "iikotowaruikoto-d5aa7.appspot.com",
  messagingSenderId: "455780219216",
  appId: "1:455780219216:web:225461fcf24c1a46f69455"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 8文字ID作成
function generateID() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let id = "";
  for (let i = 0; i < 8; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

let userID = localStorage.getItem("userID");
if (!userID) {
  userID = generateID();
  localStorage.setItem("userID", userID);
}

// BANされたら画面をBANメッセージだけに
db.ref("bans/" + userID).on("value", s => {
  if (s.exists()) {
    document.body.innerHTML = "<h1>あなたはBANされています</h1>";
  }
});

// 投票のUI更新
function updateVotesUI(votes) {
  takakingCount.innerText = (votes["タカキング"] || 0) + " 票";
  taboCount.innerText = (votes["ターボー"] || 0) + " 票";
  imakuniCount.innerText = (votes["イマクニ"] || 0) + " 票";
  keijiCount.innerText = (votes["刑事"] || 0) + " 票";
  apolloCount.innerText = (votes["アポロ"] || 0) + " 票";
}

db.ref("votes").on("value", s => updateVotesUI(s.val() || {}));

function vote() {
  const sel = document.querySelector('input[name="vote"]:checked');
  if (!sel) return alert("選んでね！");
  db.ref("votes/" + sel.value).transaction(n => (n || 0) + 1);
}

// チャット & 時間ON/OFF切替
let unknownTime = false;
function toggleUnknownTime() {
  unknownTime = !unknownTime;
  const btn = document.getElementById("timeBtn");
  btn.textContent = unknownTime ? "時間：不明" : "時間：通常";
}

const chatBox = document.getElementById("chatBox");

db.ref('messages').on('child_added', snap => {
  const msg = snap.val();
  const time = msg.timestamp === "unknown" ? "不明" : new Date(msg.timestamp).toLocaleString();
  const p = document.createElement("p");
  p.className = "message";
  p.innerHTML = `<strong>${msg.name} [${msg.userID}]</strong><br>${msg.message}<br><small>${time}</small>`;
  chatBox.prepend(p);
});

function sendMessage() {
  const name = nameInput.value.trim();
  const message = messageInput.value.trim();

  if (!name || !message) {
    alert("入力してね！");
    return;
  }

  const time = unknownTime ? "unknown" : Date.now();

  db.ref("messages").push({
    name,
    message,
    userID,
    timestamp: time
  });

  messageInput.value = "";
}

// 管理者判定
let isAdmin = false;
const adminInput = document.getElementById("adminInput");
const deleteAll = document.getElementById("deleteAll");
const banBtn = document.getElementById("banBtn");
const unbanBtn = document.getElementById("unbanBtn");
const banIDInput = document.getElementById("banIDInput");
const unbanIDInput = document.getElementById("unbanIDInput");
const banListUl = document.getElementById("banList");

// 管理者コード変更時処理
adminInput.addEventListener("change", () => {
  isAdmin = adminInput.value === "1x4s";
  alert(isAdmin ? "管理者OK" : "コードが違います");

  if (!isAdmin) {
    banListUl.innerHTML = "";
  } else {
    // 管理者になったらBANリスト表示を更新
    db.ref("bans").once("value").then(snapshot => {
      const bans = snapshot.val() || {};
      banListUl.innerHTML = "";
      for (const id in bans) {
        const li = document.createElement("li");
        li.textContent = id;
        banListUl.appendChild(li);
      }
    });
  }
});

// メッセージ一括削除ボタン
deleteAll.onclick = () => {
  if (!isAdmin) return alert("管理者のみ");
  if (confirm("全部消しますか？")) {
    db.ref("messages").remove();
    chatBox.innerHTML = "";
  }
};

// BANするボタン
banBtn.onclick = () => {
  if (!isAdmin) return alert("管理者のみ");
  const id = banIDInput.value.trim();
  if (!id) return alert("IDを入力してください");
  if (confirm(`ID「${id}」をBANしますか？`)) {
    db.ref("bans/" + id).set(true);
  }
};

// BAN解除ボタン
unbanBtn.onclick = () => {
  if (!isAdmin) return alert("管理者のみ");
  const id = unbanIDInput.value.trim();
  if (!id) return alert("IDを入力してください");
  if (confirm(`ID「${id}」のBANを解除しますか？`)) {
    db.ref("bans/" + id).remove();
  }
};

// BANリストのリアルタイム監視・表示（管理者のみ）
db.ref("bans").on("value", (snapshot) => {
  if (!isAdmin) {
    banListUl.innerHTML = "";
    return;
  }

  const bans = snapshot.val() || {};
  banListUl.innerHTML = "";

  for (const id in bans) {
    const li = document.createElement("li");
    li.textContent = id;
    banListUl.appendChild(li);
  }
});
</script>
</body>
</html>
