<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>è‰¯ã„ã“ã¨æ‚ªã„ã“ã¨è€ƒå¯Ÿç”¨</title>

<!-- ===== CSS (é»„è‰²ãƒ†ãƒ¼ãƒ) ===== -->
<style>
  :root{
    --bg: #fff8d6;
    --card: #fff3a8;
    --accent: #e6b800;
    --accent-dark: #cc9900;
    --text: #333;
    --muted: #6b5f3b;
    --danger: #c64b4b;
    --radius: 12px;
  }

  *{box-sizing:border-box;}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#fffde6);color:var(--text);font-family: "Noto Sans JP",sans-serif;padding:20px;}
  .container{max-width:980px;margin:0 auto;}

  h1{margin:0 0 12px 0;color:var(--accent-dark);font-size:1.8rem;}
  h2{margin:18px 0 8px;color:var(--accent-dark);font-size:1.2rem;}

  /* ç›®æ¬¡ */
  #toc { margin: 6px 0 18px; }
  #toc a { color: #0a66ff; text-decoration: none; font-weight:700; margin-right:12px; }
  #toc a:hover{ text-decoration: underline; }

  /* æŠ•ç¥¨ */
  .voteResult{font-weight:700;margin-left:10px;color:var(--accent-dark);background:rgba(255,255,255,0.6);padding:4px 8px;border-radius:8px;}

  /* ãƒãƒ£ãƒƒãƒˆ / ãƒ•ã‚©ãƒ¼ãƒ  */
  .card{background:var(--card);padding:12px;border-radius:var(--radius);border:1px solid rgba(0,0,0,0.06);box-shadow:0 6px 20px rgba(0,0,0,0.04);margin-bottom:16px;}
  input[type="text"], textarea { border: 1px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.6); padding:10px 12px; border-radius:10px; outline:none; font-size:1rem; width:100%; }
  textarea{resize:vertical;}
  .row{display:flex;gap:10px;align-items:center;}
  .row .btn{flex:1;padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(204,153,0,0.18);}
  .small { flex:0 0 140px; }

  /* ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º */
  #chatBox{height:340px;overflow:auto;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:#fffdf0;}
  .message{background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.8));padding:10px;border-radius:10px;margin-bottom:10px;border-left:4px solid var(--accent);box-shadow:0 2px 6px rgba(0,0,0,0.03);}
  .message strong{color:var(--accent-dark);display:block;margin-bottom:6px;}
  .message small{color:var(--muted);font-size:0.86rem;margin-left:6px;display:block;margin-top:6px;}

  /* ã‚¹ã‚¿ãƒ³ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« */
  #stampSelector{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--card);padding:14px;border-radius:10px;border:2px solid var(--accent-dark);z-index:999;}
  #stampSelector .stampList{display:flex;gap:8px;flex-wrap:wrap;max-width:360px;}
  #stampSelector .stampList img{width:64px;height:64px;border-radius:8px;border:2px solid transparent;cursor:pointer;}
  #stampSelector .stampList img:hover{border-color:var(--accent-dark);}

  /* ç®¡ç†è€…ã‚¨ãƒªã‚¢ */
  #adminBox{margin-top:18px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff9e0,#fff6d0);border:1px dashed rgba(170,119,0,0.25);}
  #adminBox .danger{color:var(--danger);font-weight:800;}

  /* ã‚ªãƒ¼ãƒŠãƒ¼ (èµ¤) */
  #ownerBox{margin-top:12px;padding:12px;border-radius:10px;background:#ffecec;border:2px solid #ffb3b3;}
  #ownerBox h3{color:var(--danger);margin:0 0 8px 0;}

  /* é–‰é–ç”»é¢ */
  #closedOverlay{display:none;position:fixed;inset:0;background:linear-gradient(180deg,#fff8d6,#fff0c0);z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:24px;}
  #closedOverlay .box{background:white;padding:18px;border-radius:12px;border:2px solid rgba(0,0,0,0.08);max-width:560px;text-align:center;}

  /* BANãƒªã‚¹ãƒˆ */
  #banList{background:#fff; padding:8px; border-radius:8px; max-height:120px; overflow:auto; border:1px solid rgba(0,0,0,0.06);}

  /* è¦‹ã¦ã„ã‚‹äºº */
  #onlineInfo{font-size:0.95rem;color:var(--muted);}

  @media(max-width:640px){.row{flex-direction:column;} .row .small{width:100%}}
</style>
</head>
<body>
<div class="container">

  <h1>è‰¯ã„ã“ã¨æ‚ªã„ã“ã¨è€ƒå¯Ÿç”¨</h1>
  <p style="margin:4px 0 12px 0;color:var(--muted)">ä½œ: ã‚‰ã‚‚</p>

  <!-- ç›®æ¬¡ -->
  <div id="toc">
    <a href="#voteSection">æŠ•ç¥¨</a>
    <a href="#messageSection">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</a>
    <a href="#adminSection">ç®¡ç†è€…æ¨©é™</a>
  </div>

  <!-- æŠ•ç¥¨ -->
  <section id="voteSection" class="card">
    <h2>æŠ•ç¥¨ãŠé¡˜ã„ã—ã¾ã™</h2>
    <p>çŠ¯äººã¯èª°ã ã¨æ€ã†ï¼Ÿ</p>

    <div><label><input type="radio" name="vote" value="ã‚¿ã‚«ã‚­ãƒ³ã‚°"> ã‚¿ã‚«ã‚­ãƒ³ã‚°</label> <span class="voteResult" id="takakingCount">0 ç¥¨</span></div>
    <div><label><input type="radio" name="vote" value="ã‚¿ãƒ¼ãƒœãƒ¼"> ã‚¿ãƒ¼ãƒœãƒ¼</label> <span class="voteResult" id="taboCount">0 ç¥¨</span></div>
    <div><label><input type="radio" name="vote" value="ã‚¿ãƒ¼ãƒœãƒ¼ã®å¦»"> ã‚¿ãƒ¼ãƒœãƒ¼ã®å¦»</label> <span class="voteResult" id="taboWifeCount">0 ç¥¨</span></div>
    <div><label><input type="radio" name="vote" value="ã‚¤ãƒã‚¯ãƒ‹"> ã‚¤ãƒã‚¯ãƒ‹</label> <span class="voteResult" id="imakuniCount">0 ç¥¨</span></div>
    <div><label><input type="radio" name="vote" value="åˆ‘äº‹"> åˆ‘äº‹</label> <span class="voteResult" id="keijiCount">0 ç¥¨</span></div>
    <div><label><input type="radio" name="vote" value="ã‚¢ãƒãƒ­"> ã‚¢ãƒãƒ­</label> <span class="voteResult" id="apolloCount">0 ç¥¨</span></div>

    <div style="margin-top:10px;">
      <button class="btn" onclick="vote()">æŠ•ç¥¨ã™ã‚‹</button>
    </div>
  </section>

  <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
  <section id="messageSection" class="card">
    <h2>ãŠè©±ã—ã‚¾ãƒ¼ãƒ³</h2>

    <label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
    <input type="text" id="nameInput" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›">

    <label>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
    <textarea id="messageInput" rows="3" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›"></textarea>

    <div class="row" style="margin-bottom:12px;">
      <button class="btn" onclick="sendMessage()">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹</button>
      <button class="btn" id="timeBtn" onclick="toggleUnknownTime()">æ™‚é–“ï¼šé€šå¸¸</button>
      <button class="btn" onclick="openStampSelector()">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸æŠ</button>
    </div>

    <!-- ã‚¹ã‚¿ãƒ³ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="stampSelector" role="dialog" aria-hidden="true">
      <h3 style="margin:0 0 8px 0;">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é¸ã‚“ã§ã­ï¼</h3>
      <div class="stampList" id="stampList"></div>
      <div style="text-align:right;margin-top:8px;"><button class="btn closeBtn" onclick="closeStampSelector()">é–‰ã˜ã‚‹</button></div>
    </div>

    <h3 style="margin-top:8px;">ã¿ã‚“ãªã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
    <div id="chatBox" aria-live="polite"></div>

    <div id="onlineInfo" style="margin-top:8px;">
      <p id="onlineCount">è¦‹ã¦ã„ã‚‹äºº: 0äºº</p>
      <p id="onlineIDs">è¦‹ã¦ã„ã‚‹äººã®ID: ãªã—</p>
    </div>
  </section>

  <!-- ç®¡ç†è€… -->
  <section id="adminSection" class="card" style="padding-bottom:18px;">
    <h2>ç®¡ç†è€…æ¨©é™</h2>

    <label>ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰</label>
    <input type="text" id="adminInput" placeholder="ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ (ç®¡ç†è€… or ã‚ªãƒ¼ãƒŠãƒ¼å…¥åŠ›å¯)">
    <div style="margin-top:8px;">
      <button class="btn" id="adminCheckBtn">èªè¨¼ã™ã‚‹</button>
    </div>

    <div id="adminPanel" style="display:none; margin-top:12px;">
      <h3>ç®¡ç†ãƒ‘ãƒãƒ«</h3>

      <div style="margin:8px 0;">
        <button class="btn" id="deleteAllBtn">âš  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€æ‹¬å‰Šé™¤</button>
      </div>

      <h4>BANã‚·ã‚¹ãƒ†ãƒ </h4>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <input type="text" id="banIDInput" placeholder="BANã™ã‚‹ID">
        <button class="btn" id="banBtn">IDæŒ‡å®šã§BANã™ã‚‹</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <input type="text" id="unbanIDInput" placeholder="è§£é™¤ã™ã‚‹ID">
        <button class="btn" id="unbanBtn">IDæŒ‡å®šã§BANã‚’è§£é™¤ã™ã‚‹</button>
      </div>

      <h4>ç¾åœ¨BANä¸­ã®IDä¸€è¦§</h4>
      <div id="banList" style="margin-top:6px;"></div>
    </div>

    <!-- ã‚ªãƒ¼ãƒŠãƒ¼å°‚ç”¨ -->
    <div id="ownerBox" style="display:none;">
      <h3>ã‚ªãƒ¼ãƒŠãƒ¼å°‚ç”¨ï¼ˆèµ¤ï¼‰</h3>
      <p style="margin:6px 0;color:var(--danger)">â€»ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ä½¿ãˆã‚‹å¼·åŠ›ãªæ“ä½œ</p>

      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
        <input type="text" id="ownerInput" placeholder="ã‚ªãƒ¼ãƒŠãƒ¼ã‚³ãƒ¼ãƒ‰">
        <button class="btn" id="ownerCheckBtn">ã‚ªãƒ¼ãƒŠãƒ¼èªè¨¼</button>
      </div>

      <div id="ownerFeatures" style="display:none;margin-top:8px;">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <button class="btn" id="closeHomepageBtn">ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹</button>
        </div>
        <p style="color:var(--danger);font-weight:700;">æ³¨æ„ï¼šé–‰ã˜ã‚‹æ“ä½œã¯å³æ™‚ã§ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</p>
      </div>
    </div>

  </section>

</div>

<!-- é–‰é–ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="closedOverlay" aria-hidden="true">
  <div class="box">
    <h2>ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯é–‰ã–ã•ã‚Œã¦ã„ã¾ã™ã€‚</h2>
    <p>ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’é–‹ã‘ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
      <input type="text" id="reopenCodeInput" placeholder="ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="width:220px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);" />
      <button class="btn" id="reopenButton">é–‹ã</button>
    </div>
    <p style="margin-top:10px;color:var(--muted)">æ­£ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ã¨ãƒšãƒ¼ã‚¸ãŒå¾©å¸°ã—ã¾ã™ã€‚</p>
  </div>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- ===== JavaScript ===== -->
<script>
/* ===== Firebase è¨­å®š ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDcds20u1-6-nk7710P4xddsa-m1wDL0TQ",
  authDomain: "iikotowaruikoto-d5aa7.firebaseapp.com",
  databaseURL: "https://iikotowaruikoto-d5aa7-default-rtdb.firebaseio.com",
  projectId: "iikotowaruikoto-d5aa7",
  storageBucket: "iikotowaruikoto-d5aa7.appspot.com",
  messagingSenderId: "455780219216",
  appId: "1:455780219216:web:225461fcf24c1a46f69455"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ===== ãƒ¦ãƒ¼ã‚¶ãƒ¼IDä½œæˆï¼ˆ8æ–‡å­—ï¼‰ ===== */
function generateID() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let id = "";
  for (let i=0;i<8;i++) id += chars.charAt(Math.floor(Math.random()*chars.length));
  return id;
}
let userID = localStorage.getItem("userID");
if (!userID) { userID = generateID(); localStorage.setItem("userID", userID); }

/* BANã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆå€‹åˆ¥ï¼‰ */
db.ref("bans/" + userID).on("value", s => {
  if (s.exists()) {
    // BANã•ã‚ŒãŸã‚‰è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ï¼ˆãƒšãƒ¼ã‚¸åˆ©ç”¨ä¸å¯ï¼‰
    document.body.innerHTML = "<h1 style='padding:30px;text-align:center;color:#c64b4b;'>ã‚ãªãŸã¯BANã•ã‚Œã¦ã„ã¾ã™</h1>";
  }
});

/* ===== æŠ•ç¥¨ ===== */
function updateVotesUI(votes) {
  document.getElementById("takakingCount").innerText = (votes["ã‚¿ã‚«ã‚­ãƒ³ã‚°"] || 0) + " ç¥¨";
  document.getElementById("taboCount").innerText = (votes["ã‚¿ãƒ¼ãƒœãƒ¼"] || 0) + " ç¥¨";
  document.getElementById("taboWifeCount").innerText = (votes["ã‚¿ãƒ¼ãƒœãƒ¼ã®å¦»"] || 0) + " ç¥¨";
  document.getElementById("imakuniCount").innerText = (votes["ã‚¤ãƒã‚¯ãƒ‹"] || 0) + " ç¥¨";
  document.getElementById("keijiCount").innerText = (votes["åˆ‘äº‹"] || 0) + " ç¥¨";
  document.getElementById("apolloCount").innerText = (votes["ã‚¢ãƒãƒ­"] || 0) + " ç¥¨";
}
db.ref("votes").on("value", snap => updateVotesUI(snap.val() || {}));

function vote(){
  const sel = document.querySelector('input[name="vote"]:checked');
  if (!sel) return alert("èª°ã‹ã‚’é¸ã‚“ã§ã­ï¼");
  db.ref("votes/" + sel.value).transaction(n => (n||0)+1);
  alert("æŠ•ç¥¨ã‚ã‚ŠãŒã¨ã†ï¼");
}

/* ===== ãƒãƒ£ãƒƒãƒˆ / æ™‚é–“ãƒˆã‚°ãƒ« ===== */
let unknownTime = false;
function toggleUnknownTime(){
  unknownTime = !unknownTime;
  document.getElementById("timeBtn").textContent = unknownTime ? "æ™‚é–“ï¼šä¸æ˜" : "æ™‚é–“ï¼šé€šå¸¸";
}

/* ãƒãƒ£ãƒƒãƒˆå—ä¿¡è¡¨ç¤ºï¼ˆæœ€æ–°ã‚’ä¸Šã«ï¼‰ */
const chatBox = document.getElementById("chatBox");
db.ref('messages').on('child_added', snap => {
  const msg = snap.val();
  if (!msg) return;
  const timeText = (msg.timestamp === "unknown") ? "ä¸æ˜" : new Date(msg.timestamp).toLocaleString();
  const p = document.createElement("div");
  p.className = "message";
  if (msg.type === "stamp") {
    p.innerHTML = `<strong>${escapeHtml(msg.name)} [${escapeHtml(msg.userID)}]</strong>
                   <div><img src="${escapeAttr(msg.stampUrl)}" alt="stamp" style="max-width:160px;border-radius:8px;"></div>
                   <small>æ™‚é–“ï¼š${escapeHtml(timeText)}</small>`;
  } else {
    p.innerHTML = `<strong>${escapeHtml(msg.name)} [${escapeHtml(msg.userID)}]</strong>
                   <div>${escapeHtml(msg.message)}</div>
                   <small>æ™‚é–“ï¼š${escapeHtml(timeText)}</small>`;
  }
  chatBox.prepend(p);
});

/* é€ä¿¡å‡¦ç†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰ */
function sendMessage(){
  const name = document.getElementById("nameInput").value.trim();
  const message = document.getElementById("messageInput").value.trim();
  if (!name || !message) { alert("åå‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥ã‚Œã¦ã­ï¼"); return; }
  const ts = unknownTime ? "unknown" : Date.now();
  db.ref("messages").push({ name, message, userID, timestamp: ts, type: "text" });
  document.getElementById("messageInput").value = "";
}

/* ===== ã‚¹ã‚¿ãƒ³ãƒ—æ©Ÿèƒ½ ===== */
const stamps = ["stamp1.png","stamp2.png","stamp3.png"];
const stampListEl = document.getElementById("stampList");
function openStampSelector(){
  stampListEl.innerHTML = "";
  stamps.forEach(src => {
    const img = document.createElement("img");
    img.src = src;
    img.alt = "stamp";
    img.onclick = () => { sendStamp(src); closeStampSelector(); };
    stampListEl.appendChild(img);
  });
  document.getElementById("stampSelector").style.display = "block";
  document.getElementById("stampSelector").setAttribute("aria-hidden","false");
}
function closeStampSelector(){
  document.getElementById("stampSelector").style.display = "none";
  document.getElementById("stampSelector").setAttribute("aria-hidden","true");
}
function sendStamp(stampUrl){
  const name = document.getElementById("nameInput").value.trim();
  if (!name) { alert("ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥ã‚Œã¦ã­ï¼"); return; }
  const ts = unknownTime ? "unknown" : Date.now();
  db.ref("messages").push({ name, type: "stamp", stampUrl, userID, timestamp: ts });
}

/* ===== ç®¡ç†è€… / ã‚ªãƒ¼ãƒŠãƒ¼ ===== */
let isAdmin = false;
let isOwner = false;
const ADMIN_CODE = "1x4s";
const OWNER_CODE = "5y3y";

document.getElementById("adminCheckBtn").addEventListener("click", () => {
  const v = document.getElementById("adminInput").value.trim();
  if (v === ADMIN_CODE) {
    isAdmin = true;
    document.getElementById("adminPanel").style.display = "block";
    alert("âœ… ç®¡ç†è€…æ¨©é™OK");
  } else if (v === OWNER_CODE) {
    isOwner = true;
    isAdmin = true; // ã‚ªãƒ¼ãƒŠãƒ¼ã¯ç®¡ç†è€…æ¨©é™ã‚‚æŒã¤
    document.getElementById("adminPanel").style.display = "block";
    document.getElementById("ownerBox").style.display = "block";
    document.getElementById("ownerFeatures").style.display = "block";
    alert("ğŸ”¥ ã‚ªãƒ¼ãƒŠãƒ¼æ¨©é™OK");
  } else {
    alert("ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  }
});

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€æ‹¬å‰Šé™¤ï¼ˆç®¡ç†è€…ï¼‰ */
document.getElementById("deleteAllBtn").addEventListener("click", () => {
  if (!isAdmin) return alert("ç®¡ç†è€…ã®ã¿ä½¿ãˆã¾ã™");
  if (!confirm("æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
  db.ref("messages").remove().then(()=> { chatBox.innerHTML=""; alert("å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"); });
});

/* BAN/UNBAN */
document.getElementById("banBtn").addEventListener("click", () => {
  if (!isAdmin) return alert("ç®¡ç†è€…ã®ã¿ä½¿ãˆã¾ã™");
  const id = document.getElementById("banIDInput").value.trim();
  if (!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ã­");
  if (!confirm(`IDã€Œ${id}ã€ã‚’BANã—ã¾ã™ã‹ï¼Ÿ`)) return;
  db.ref("bans/" + id).set(true);
});
document.getElementById("unbanBtn").addEventListener("click", () => {
  if (!isAdmin) return alert("ç®¡ç†è€…ã®ã¿ä½¿ãˆã¾ã™");
  const id = document.getElementById("unbanIDInput").value.trim();
  if (!id) return alert("IDã‚’å…¥åŠ›ã—ã¦ã­");
  if (!confirm(`IDã€Œ${id}ã€ã®BANã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  db.ref("bans/" + id).remove();
});

/* BANãƒªã‚¹ãƒˆè¡¨ç¤º */
const banListEl = document.getElementById("banList");
db.ref("bans").on("value", snap => {
  const bans = snap.val() || {};
  const ids = Object.keys(bans);
  if (ids.length===0) banListEl.innerText = "ãªã—";
  else {
    banListEl.innerHTML = ids.map(id => `<div style="padding:6px;border-bottom:1px solid rgba(0,0,0,0.04)">${escapeHtml(id)}</div>`).join("");
  }
});

/* ===== ã‚ªãƒ¼ãƒŠãƒ¼ï¼šãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸é–‰ã˜ã‚‹ / é–‹ã‘ã‚‹ ===== */
document.getElementById("ownerCheckBtn").addEventListener("click", () => {
  const v = document.getElementById("ownerInput").value.trim();
  if (v === OWNER_CODE) {
    isOwner = true;
    document.getElementById("ownerFeatures").style.display = "block";
    alert("ã‚ªãƒ¼ãƒŠãƒ¼èªè¨¼OK");
  } else {
    alert("ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  }
});

document.getElementById("closeHomepageBtn").addEventListener("click", () => {
  if (!isOwner) return alert("ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ä½¿ãˆã¾ã™");
  if (!confirm("æœ¬å½“ã«ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®ã‚¿ãƒ–ã¯é–‰ã–ã•ã‚ŒãŸè¡¨ç¤ºã«ãªã‚Šã¾ã™ï¼‰")) return;
  // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆï¼šé–‰é–ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
  document.getElementById("closedOverlay").style.display = "flex";
  document.getElementById("closedOverlay").setAttribute("aria-hidden","false");
  // ãƒ¡ã‚¤ãƒ³ã‚’å°‘ã—éš ã™ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹çš„ã«ï¼‰
  window.scrollTo(0,0);
});

/* å†é–‹å‡¦ç† */
document.getElementById("reopenButton").addEventListener("click", () => {
  const code = document.getElementById("reopenCodeInput").value.trim();
  if (code === OWNER_CODE) {
    document.getElementById("closedOverlay").style.display = "none";
    document.getElementById("closedOverlay").setAttribute("aria-hidden","true");
    alert("ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸ");
  } else {
    alert("ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
  }
});

/* ===== è¦‹ã¦ã„ã‚‹äººï¼ˆpresenceï¼‰ ===== */
const presenceRef = db.ref("presence/" + userID);
const presenceListRef = db.ref("presence");
db.ref(".info/connected").on("value", snap => {
  if (snap.val() === true) {
    presenceRef.set(true);
    presenceRef.onDisconnect().remove();
  }
});

let currentBanIDs = [];
let currentPresenceIDs = [];
const onlineCountP = document.getElementById("onlineCount");
const onlineIDsP = document.getElementById("onlineIDs");

function updateOnlineDisplay(){
  const visibleIDs = currentPresenceIDs.filter(id => !currentBanIDs.includes(id));
  onlineCountP.textContent = `è¦‹ã¦ã„ã‚‹äºº: ${visibleIDs.length}äºº`;
  onlineIDsP.textContent = visibleIDs.length === 0 ? "è¦‹ã¦ã„ã‚‹äººã®ID: ãªã—" : `è¦‹ã¦ã„ã‚‹äººã®ID: ${visibleIDs.join(", ")}`;
}

db.ref("bans").on("value", snap => {
  const bans = snap.val() || {};
  currentBanIDs = Object.keys(bans);
  updateOnlineDisplay();
});

presenceListRef.on("value", snap => {
  const ids = [];
  snap.forEach(child => ids.push(child.key));
  currentPresenceIDs = ids;
  updateOnlineDisplay();
});

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: XSSå¯¾ç­–ã§è¡¨ç¤ºã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ— ===== */
function escapeHtml(s){ if(!s && s!==0) return ""; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

/* ===== åˆæœŸåŒ–ï¼ˆç”»é¢è¦ç´ ã®IDå‚ç…§ã‚’å®‰å…¨ã«è¡Œã†ãŸã‚ï¼‰ ===== */
(function initUI(){
  // ãƒœã‚¿ãƒ³IDãªã©ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã¯çœç•¥ï¼ˆæ—¢ã« DOM ã«ã‚ã‚‹ï¼‰
})();
</script>
</body>
</html>
