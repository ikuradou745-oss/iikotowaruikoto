<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>良いこと悪いこと考察用</title>

<style>
  body { 
    font-family: sans-serif; 
    background: #ffffcc; 
    padding: 20px; 
  }

  .voteResult {
    font-weight: bold; 
    margin-left: 10px; 
    color: #cc9900;
  }

  #chatBox { 
    border: 1px solid #cc9900; 
    background: #fff8b3; 
    padding: 10px; 
    height: 300px; 
    overflow-y: auto; 
  }

  input, textarea { 
    width: 100%; 
    margin-bottom: 10px; 
    padding: 8px; 
    font-size: 1em; 
  }

  button { 
    background-color: #cc9900; 
    color: white; 
    padding: 10px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    margin-bottom: 10px;
  }

  p.message {
    border-bottom: 1px solid #cc9900;
    padding-bottom: 5px;
    margin-bottom: 5px;
  }

  p.message strong {
    color: #995500;
  }

  p.message time {
    color: #666;
    font-size: 0.8em;
    margin-left: 5px;
  }

  #adminBox {
    margin-top: 40px;
    padding: 15px;
    border: 2px dashed #aa7700;
    background: #fff3a0;
  }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<h1>良いこと悪いこと考察用</h1>
<p>作: らも</p>

<h2>投票お願いします</h2>
<p>犯人は誰だと思う？</p>

<div>
  <label><input type="radio" name="vote" value="タカキング"> タカキング！</label>
  <span class="voteResult" id="takakingCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="ターボー"> ターボー</label>
  <span class="voteResult" id="taboCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="イマクニ"> イマクニ？</label>
  <span class="voteResult" id="imakuniCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="刑事"> 刑事？</label>
  <span class="voteResult" id="keijiCount">0 票</span>
</div>

<div>
  <label><input type="radio" name="vote" value="アポロ"> アポロとか！</label>
  <span class="voteResult" id="apolloCount">0 票</span>
</div>

<button onclick="vote()">投票する</button>

<hr>

<h2>お話しゾーン</h2>

<p>ニックネーム</p>
<input type="text" id="nameInput" placeholder="ニックネームを入力">

<p>メッセージを入れてね</p>
<textarea id="messageInput" rows="4" placeholder="メッセージを入力"></textarea>

<button onclick="sendMessage()">メッセージ送る</button>

<h3>みんなのメッセージ</h3>
<div id="chatBox"></div>

<div id="adminBox">
  <h2>管理者権限</h2>
  <p>管理者パスワード</p>
  <input type="text" id="adminInput" placeholder="管理者用コードを入力">
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDcds20u1-6-nk7710P4xddsa-m1wDL0TQ",
    authDomain: "iikotowaruikoto-d5aa7.firebaseapp.com",
    databaseURL: "https://iikotowaruikoto-d5aa7-default-rtdb.firebaseio.com",
    projectId: "iikotowaruikoto-d5aa7",
    storageBucket: "iikotowaruikoto-d5aa7.appspot.com",
    messagingSenderId: "455780219216",
    appId: "1:455780219216:web:225461fcf24c1a46f69455"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ===== 8文字ID生成 =====
  function generateID() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let id = "";
    for (let i = 0; i < 8; i++) {
      id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
  }

  let userID = localStorage.getItem("userID");
  if (!userID) {
    userID = generateID();
    localStorage.setItem("userID", userID);
  }

  // ===== BANチェック =====
  const body = document.body;

  db.ref("banned/" + userID).on("value", (snapshot) => {
    if (snapshot.exists()) {
      body.innerHTML = "<h1>あなたはBANされています。</h1>";
    }
  });

  // ===== 投票 =====
  function updateVotesUI(votes) {
    document.getElementById("takakingCount").innerText = (votes["タカキング"] || 0) + " 票";
    document.getElementById("taboCount").innerText = (votes["ターボー"] || 0) + " 票";
    document.getElementById("imakuniCount").innerText = (votes["イマクニ"] || 0) + " 票";
    document.getElementById("keijiCount").innerText = (votes["刑事"] || 0) + " 票";
    document.getElementById("apolloCount").innerText = (votes["アポロ"] || 0) + " 票";
  }

  db.ref('votes').on('value', (snapshot) => {
    const votes = snapshot.val() || {};
    updateVotesUI(votes);
  });

  function vote() {
    const selected = document.querySelector('input[name="vote"]:checked');
    if (!selected) {
      alert("誰かを選んでね！");
      return;
    }
    const voteName = selected.value;
    db.ref('votes/' + voteName).transaction(current => (current || 0) + 1);
  }

  // ===== チャット =====
  const chatBox = document.getElementById("chatBox");

  db.ref('messages').on('child_added', (snapshot) => {
    const msg = snapshot.val();
    if (msg && msg.name && msg.message && msg.timestamp && msg.userID) {
      const p = document.createElement('p');
      p.className = 'message';
      const dateStr = new Date(msg.timestamp).toLocaleString();
      p.innerHTML = `<strong>${msg.name} [${msg.userID}]</strong> <time>${dateStr}</time><br>${msg.message}`;
      chatBox.prepend(p);
    }
  });

  function sendMessage() {
    const name = document.getElementById("nameInput").value.trim();
    const message = document.getElementById("messageInput").value.trim();

    if (!name || !message) {
      alert("名前とメッセージを入れてね！");
      return;
    }

    db.ref('messages').push({ 
      name, 
      message, 
      timestamp: Date.now(),
      userID
    });

    document.getElementById("messageInput").value = "";
  }

  // ===== 管理者機能 =====
  let isAdmin = false;

  document.getElementById("adminInput").addEventListener("change", function() {
    if (this.value === "1x4s") {
      isAdmin = true;
      alert("✅ 管理者になりました");
    } else {
      isAdmin = false;
      alert("❌ コードが違います");
    }
  });

  const adminBox = document.getElementById("adminBox");

  // メッセージ全削除
  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "⚠ メッセージ一括削除";
  deleteBtn.onclick = () => {
    if (!isAdmin) return alert("管理者じゃないよ！");
    if (confirm("本当にすべて消す？")) {
      db.ref("messages").remove();
      chatBox.innerHTML = "";
    }
  };
  adminBox.appendChild(deleteBtn);

  // BAN入力欄
  const banInput = document.createElement("input");
  banInput.placeholder = "BANするID";
  adminBox.appendChild(banInput);

  // BANボタン
  const banBtn = document.createElement("button");
  banBtn.textContent = "ID指定でBANする";
  banBtn.onclick = () => {
    if (!isAdmin) return alert("管理者じゃないよ！");
    if (!banInput.value) return alert("IDを入れてね！");
    db.ref("banned/" + banInput.value).set(true);
    alert("BANしました");
  };
  adminBox.appendChild(banBtn);

  // BAN解除欄
  const unbanInput = document.createElement("input");
  unbanInput.placeholder = "BAN解除するID";
  adminBox.appendChild(unbanInput);

  // BAN解除ボタン
  const unbanBtn = document.createElement("button");
  unbanBtn.textContent = "ID指定でBAN解除する";
  unbanBtn.onclick = () => {
    if (!isAdmin) return alert("管理者じゃないよ！");
    if (!unbanInput.value) return alert("IDを入れてね！");
    db.ref("banned/" + unbanInput.value).remove();
    alert("BAN解除しました");
  };
  adminBox.appendChild(unbanBtn);

</script>

</body>
</html>
