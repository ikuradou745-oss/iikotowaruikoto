<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>良いこと悪いこと考察用</title>

<style>
  body { 
    font-family: sans-serif; 
    background: #ffffcc; 
    padding: 20px; 
  }

  .voteResult {
    font-weight: bold; 
    margin-left: 10px; 
    color: #cc9900;
  }

  #chatBox { 
    border: 1px solid #cc9900; 
    background: #fff8b3; 
    padding: 10px; 
    height: 300px; 
    overflow-y: auto; 
  }

  input, textarea { 
    width: 100%; 
    margin-bottom: 10px; 
    padding: 8px; 
    font-size: 1em; 
  }

  button { 
    background-color: #cc9900; 
    color: white; 
    padding: 10px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
    margin-bottom: 10px;
  }

  .row {
    display: flex;
    gap: 10px;
  }

  .row button {
    flex: 1;
  }

  p.message {
    border-bottom: 1px solid #cc9900;
    padding-bottom: 5px;
    margin-bottom: 5px;
  }

  #adminBox {
    margin-top: 40px;
    padding: 15px;
    border: 2px dashed #aa7700;
    background: #fff3a0;
  }

  #stampPanel {
    display: none;
    margin-bottom: 10px;
    border: 1px solid #cc9900;
    background: #fff8b3;
    padding: 10px;
    border-radius: 6px;
  }

  #stampPanel img {
    cursor: pointer;
    width: 60px;
    margin: 5px;
    border: 2px solid transparent;
    border-radius: 6px;
    transition: border-color 0.3s;
  }
  #stampPanel img:hover {
    border-color: #cc9900;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<h1>良いこと悪いこと考察用</h1>
<p>作: らも</p>

<h2>お話しゾーン</h2>

<p>ニックネーム</p>
<input type="text" id="nameInput" placeholder="ニックネーム">

<p>メッセージ</p>
<textarea id="messageInput" rows="4"></textarea>

<div class="row">
  <button onclick="sendMessage()">メッセージを送る</button>
  <button onclick="toggleUnknownTime()" id="timeBtn">時間：通常</button>
  <button onclick="toggleStampPanel()">スタンプを選択</button>
</div>

<!-- スタンプ選択パネル -->
<div id="stampPanel">
  <img src="stamp1.png" alt="スタンプ1" onclick="sendStamp('stamp1.png')">
  <!-- 他のスタンプ画像もここに追加可能 -->
</div>

<h3>みんなのメッセージ</h3>
<div id="chatBox"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDcds20u1-6-nk7710P4xddsa-m1wDL0TQ",
  authDomain: "iikotowaruikoto-d5aa7.firebaseapp.com",
  databaseURL: "https://iikotowaruikoto-d5aa7-default-rtdb.firebaseio.com",
  projectId: "iikotowaruikoto-d5aa7",
  storageBucket: "iikotowaruikoto-d5aa7.appspot.com",
  messagingSenderId: "455780219216",
  appId: "1:455780219216:web:225461fcf24c1a46f69455"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function generateID() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let id = "";
  for (let i = 0; i < 8; i++) {
    id += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return id;
}

let userID = localStorage.getItem("userID");
if (!userID) {
  userID = generateID();
  localStorage.setItem("userID", userID);
}

let unknownTime = false;

function toggleUnknownTime() {
  unknownTime = !unknownTime;
  const btn = document.getElementById("timeBtn");
  btn.textContent = unknownTime ? "時間：不明" : "時間：通常";
}

function toggleStampPanel() {
  const panel = document.getElementById("stampPanel");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

const chatBox = document.getElementById("chatBox");
const nameInput = document.getElementById("nameInput");
const messageInput = document.getElementById("messageInput");

db.ref('messages').on('child_added', snap => {
  const msg = snap.val();
  const timeText = msg.timestamp === "unknown" ? "時間：不明" : `時間：${new Date(msg.timestamp).toLocaleString()}`;
  const p = document.createElement("p");
  p.className = "message";
  if (msg.message.startsWith('<img')) {
    // スタンプの場合は画像をそのまま表示
    p.innerHTML = `<strong>${msg.name} [${msg.userID}]</strong><br>${msg.message}<br><small>${timeText}</small>`;
  } else {
    // 普通のメッセージ
    p.innerHTML = `<strong>${msg.name} [${msg.userID}]</strong><br>${msg.message}<br><small>${timeText}</small>`;
  }
  chatBox.prepend(p);
});

function sendMessage() {
  const name = nameInput.value.trim();
  const message = messageInput.value.trim();

  if (!name || !message) {
    alert("ニックネームとメッセージを入力してください！");
    return;
  }

  const time = unknownTime ? "unknown" : Date.now();

  db.ref("messages").push({
    name,
    message,
    userID,
    timestamp: time
  });

  messageInput.value = "";
}

function sendStamp(stampUrl) {
  const name = nameInput.value.trim();
  if (!name) {
    alert("ニックネームを入力してください！");
    return;
  }
  const time = unknownTime ? "unknown" : Date.now();

  db.ref("messages").push({
    name,
    message: `<img src="${stampUrl}" style="max-width: 100px;">`,
    userID,
    timestamp: time
  });
  // スタンプ送信後にパネルを閉じる
  document.getElementById("stampPanel").style.display = "none";
}
</script>
</body>
</html>
