<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ホームページ</title>
<style>
    body {
        font-family: sans-serif;
        margin: 20px;
    }

    h2 {
        margin-top: 40px;
    }

    /* 目次リンク（青色） */
    .toc a {
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
        font-size: 20px;
    }

    .stamp-img {
        width: 70px;
        cursor: pointer;
        margin-right: 10px;
    }

    .adminOnly { display: none; }
    .ownerOnly { display: none; }

    .ban-label { color: red; font-weight: bold; }
</style>
</head>
<body>

<h1>作：らも</h1>

<!-- ーーーーーーーーーーーーーー -->
<!-- 目次 -->
<!-- ーーーーーーーーーーーーーー -->
<h2>ー目次ー</h2>
<div class="toc">
    <a onclick="scrollToSection('vote-section')">投票</a> / 
    <a onclick="scrollToSection('message-section')">メッセージ</a> / 
    <a onclick="scrollToSection('admin-section')">管理者権限</a>
</div>

<!-- ーーーーーーーーーーーーーー -->
<!-- ★ 閉鎖画面（最初は非表示） -->
<!-- ーーーーーーーーーーーーーー -->
<div id="closed-screen" style="display:none; margin-top:40px;">
    <h2 style="color:red;">ホームページは閉ざされています。</h2>
    <p>ホームページを開けるコードを入力</p>
    <input id="reopenCode" placeholder="コードを入力">
    <button onclick="tryReopen()">開ける</button>
</div>

<!-- ーーーーーーーーーーーーーー -->
<!-- 投票 -->
<!-- ーーーーーーーーーーーーーー -->
<h2 id="vote-section">投票</h2>
<select id="voteSelect">
    <option value="ターボー">ターボー</option>
    <option value="ターボーの妻">ターボーの妻</option>
    <option value="サトシ">サトシ</option>
</select>
<button onclick="sendVote()">投票する</button>

<p>現在の票：</p>
<ul id="voteList"></ul>

<!-- ーーーーーーーーーーーーーー -->
<!-- メッセージ -->
<!-- ーーーーーーーーーーーーーー -->
<h2 id="message-section">みんなのメッセージ</h2>

<input id="name" placeholder="名前"><br>
<input id="userid" placeholder="ID"><br>
<input id="message" placeholder="メッセージ"><br>
<button onclick="sendMessage()">送信</button>

<h3>スタンプを選択</h3>
<div>
    <img src="stamp1.png" class="stamp-img" onclick="sendStamp('stamp1.png')">
    <img src="stamp2.png" class="stamp-img" onclick="sendStamp('stamp2.png')">
    <img src="stamp3.png" class="stamp-img" onclick="sendStamp('stamp3.png')">
</div>

<ul id="messageList"></ul>

<h3>見ている人</h3>
<p>人数：<span id="viewerCount">0</span></p>
<ul id="viewerList"></ul>

<!-- ーーーーーーーーーーーーーー -->
<!-- 管理者権限 -->
<!-- ーーーーーーーーーーーーーー -->
<h2 id="admin-section">管理者権限</h2>

<p>管理者コード</p>
<input id="adminCodeInput" placeholder="コードを入力">
<button onclick="checkAdmin()">送信</button>

<div id="adminControls" class="adminOnly">
    <h3>管理者メニュー</h3>
    <p>メッセージ削除</p>
    <input id="deleteId" placeholder="削除するメッセージID">
    <button onclick="deleteMessage()">削除</button>

    <p>BANするID</p>
    <input id="banId" placeholder="BANするID">
    <button onclick="banUser()">BAN</button>

    <p>BAN解除</p>
    <input id="unbanId" placeholder="解除するID">
    <button onclick="unbanUser()">unBAN</button>
</div>

<!-- ーーーーーーーーーーーーーー -->
<!-- オーナー専用 -->
<!-- ーーーーーーーーーーーーーー -->
<div id="ownerControls" class="ownerOnly">
    <h3>オーナー専用</h3>

    <button onclick="closeHomepage()">ホームページを閉じる</button>
</div>

<!-- Firebase（キミの設定を書く） -->
<script type="module">
    //=============================
    // Firebase 設定（自分のに差し替えてOK）
    //=============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
        getDatabase, ref, set, push, onValue, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = YOUR_FIREBASE_CONFIG;
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const closedRef = ref(db, "system/closed");

    //=============================
    // ページ閉鎖チェック
    //=============================
    onValue(closedRef, (snap) => {
        const isClosed = snap.val();

        if (isClosed === true) {
            document.getElementById("closed-screen").style.display = "block";
            document.body.style.display = "block";
        } else {
            document.getElementById("closed-screen").style.display = "none";
        }
    });

    window.tryReopen = function () {
        const code = document.getElementById("reopenCode").value;
        if (code === "5y3y") {
            set(closedRef, false);
            alert("ホームページを開きました！");
        } else {
            alert("コードが違います");
        }
    };

    //=============================
    // 管理者 & オーナーチェック
    //=============================
    window.checkAdmin = function () {
        const code = document.getElementById("adminCodeInput").value;

        if (code === "1x4s") {
            document.querySelectorAll(".adminOnly").forEach(e => e.style.display = "block");
            alert("管理者権限 ON");
        }

        if (code === "5y3y") {
            document.querySelectorAll(".ownerOnly").forEach(e => e.style.display = "block");
            alert("オーナー権限 ON");
        }
    };

    //=============================
    // ホームページ閉鎖（オーナー）
    //=============================
    window.closeHomepage = function () {
        if (confirm("本当に閉じますか？")) {
            set(closedRef, true);
            alert("閉鎖しました。");
        }
    };

    //=============================
    // 投票
    //=============================
    const voteRef = ref(db, "vote");

    window.sendVote = function () {
        const item = document.getElementById("voteSelect").value;
        push(voteRef, item);
    };

    onValue(voteRef, (snap) => {
        const data = snap.val() || {};
        const list = document.getElementById("voteList");
        list.innerHTML = "";

        const count = {};

        for (let id in data) {
            const v = data[id];
            if (!count[v]) count[v] = 0;
            count[v]++;
        }

        for (let key in count) {
            const li = document.createElement("li");
            li.textContent = `${key}：${count[key]}票`;
            list.appendChild(li);
        }
    });

    //=============================
    // メッセージ & スタンプ
    //=============================
    const msgRef = ref(db, "messages");

    window.sendMessage = function () {
        const name = document.getElementById("name").value;
        const uid  = document.getElementById("userid").value;
        const msg  = document.getElementById("message").value;

        push(msgRef, {
            name, uid, msg,
            time: new Date().toLocaleString()
        });
    };

    window.sendStamp = function (img) {
        const name = document.getElementById("name").value;
        const uid  = document.getElementById("userid").value;

        push(msgRef, {
            name, uid,
            stamp: img,
            time: new Date().toLocaleString()
        });
    };

    onValue(msgRef, (snap) => {
        const data = snap.val() || {};
        const list = document.getElementById("messageList");
        list.innerHTML = "";

        for (let id in data) {
            const m = data[id];

            const li = document.createElement("li");
            li.innerHTML = `
                <b>${m.name}</b> (${m.uid})<br>
                ${m.msg ? m.msg : `<img src="${m.stamp}" width="70">`}<br>
                <small>${m.time}</small>
                <br>ID: ${id}
            `;
            list.appendChild(li);
        }
    });

    //=============================
    // メッセージ削除（管理者）
    //=============================
    window.deleteMessage = function () {
        const id = document.getElementById("deleteId").value;
        remove(ref(db, "messages/" + id));
    };

    //=============================
    // BAN システム
    //=============================
    const banRef = ref(db, "ban");

    window.banUser = function () {
        const uid = document.getElementById("banId").value;
        set(ref(db, "ban/" + uid), true);
        alert("BANしました");
    };

    window.unbanUser = function () {
        const uid = document.getElementById("unbanId").value;
        remove(ref(db, "ban/" + uid));
        alert("解除しました");
    };

    //=============================
    // 見ている人（リアルタイム）
    //=============================
    const viewersRef = ref(db, "viewers");
    const myId = Math.random().toString(36).slice(2);

    // 自分を追加
    set(ref(db, "viewers/" + myId), {
        time: Date.now()
    });

    // 離脱時に削除
    window.addEventListener("beforeunload", () => {
        remove(ref(db, "viewers/" + myId));
    });

    onValue(viewersRef, (snap) => {
        const data = snap.val() || {};

        const list = document.getElementById("viewerList");
        list.innerHTML = "";

        let count = 0;

        for (let id in data) {
            count++;
            const li = document.createElement("li");
            li.textContent = id;
            list.appendChild(li);
        }

        document.getElementById("viewerCount").textContent = count;
    });
</script>

<script>
function scrollToSection(id) {
    document.getElementById(id).scrollIntoView({ behavior: "smooth" });
}
</script>

</body>
</html>
